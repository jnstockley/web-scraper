---
name: Sync from Python Starter

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  sync:
    if: ${{ github.repository != 'jnstockley/python-starter' }}
    runs-on: ubuntu-latest
    environment: sync
    name: Sync
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v6
        with:
          ref: 'dev'
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Fetch external repo and create sync branch
        id: sync
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add external https://github.com/jnstockley/python-starter.git
          git fetch external main
          # Merge external main into current branch, allow conflicts to surface
          git merge external/main --allow-unrelated-histories || true
          # Check if there are changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Add and commit changes
            git add -A
            git commit -m "Pull changes from python-starter (may include conflicts)"
          fi

      - name: Create Pull Request if differences exist
        if: steps.sync.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_TOKEN }}
          base: dev
          title: "Sync from python-starter"
          body: |
            This PR syncs changes from [jnstockley/python-starter](https://github.com/jnstockley/python-starter).
          branch: sync
          delete-branch: true
